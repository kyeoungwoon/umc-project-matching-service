name: Backend Build&Deploy Docker Image w/ largeserver

on:
#  push:
#    branches:
#      - main
#    # ğŸ‘‡ BE, ê³µìœ  íŒ¨í‚¤ì§€ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
#    paths:
#      - "apps/api/**"
#      - "packages/**"
#      - "package.json"
#      - "pnpm-lock.yaml"
#      - "pnpm-workspace.yaml"
  workflow_dispatch:

jobs:
  build-docker-image-and-push:
    name: Build and Push to Docker Hub
    # runs-on: ubuntu-latest
    runs-on: [self-hosted, largeserver]
    strategy:
      # ğŸ‘‡ amd64ì™€ arm64ë¥¼ ë³‘ë ¬ë¡œ ë…ë¦½ì ìœ¼ë¡œ ë¹Œë“œ
      matrix:
        platform: [linux/amd64, linux/arm64]
        include:
          - platform: linux/amd64
            tag-suffix: amd64
          - platform: linux/arm64
            tag-suffix: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # QEMU ì„¤ì • (ë‹¤ë¥¸ ì•„í‚¤í…ì²˜ ì—ë®¬ë ˆì´ì…˜)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Docker Buildx ë¹Œë” ì„¤ì •
      # multi-archë¥¼ ì§€ì›í•˜ëŠ” ë“œë¼ì´ë²„ë¡œ ìë™ ì „í™˜
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # ìœ„ì—ì„œ ì‘ì„±í•œ Dockerfileì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  íƒœê¹…í•˜ì—¬ í‘¸ì‹œí•©ë‹ˆë‹¤.
      # - name: Build and push Docker image
      #   uses: docker/build-push-action@v6
      #   with:
      #     context: ${{secrets.DOCKER_BUILD_CONTEXT_PATH}} # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œ
      #     file: ${{secrets.DOCKER_DOCKERFILE_PATH}} # Dockerfile path
      #     push: true # ë¹Œë“œ í›„ í‘¸ì‹œ ì‹¤í–‰
      #     tags: ${{secrets.DOCKER_IMAGE_NAME_WITH_TAG}} # versionì€ latestë¡œ ìš°ì„  ê³ ì •
      #     platforms: linux/amd64,linux/arm64

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          # ëª¨ë…¸ë ˆí¬ ë£¨íŠ¸ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ ì§€ì •
          context: .
          # Dockerfileì˜ ì‹¤ì œ ìœ„ì¹˜
          file: apps/api/scripts/docker/dockerfile
          push: true
          # ì•„í‚¤í…ì²˜ë³„ë¡œ ë‹¤ë¥¸ íƒœê·¸
          tags: ${{ secrets.DOCKER_IMAGE_NAME }}:${{ matrix.tag-suffix }}
          # í•œ ë²ˆì— í•˜ë‚˜ì˜ í”Œë«í¼ë§Œ ë¹Œë“œ
          platforms: ${{ matrix.platform }}
          # ë¹Œë“œ ìºì‹œ ì‚¬ìš©ìœ¼ë¡œ ì†ë„ ìµœì í™”
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==================================================================================
  # JOB 2: ë¶„ë¦¬ëœ ì´ë¯¸ì§€ë¥¼ í•˜ë‚˜ì˜ íƒœê·¸(:latest)ë¡œ í•©ì¹˜ê¸° (Manifest)
  # ==================================================================================
  merge-manifest:
    name: Create Docker Manifest
    needs: build-docker-image-and-push
    runs-on: largeserver
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          # amd64ì™€ arm64 ì´ë¯¸ì§€ë¥¼ ë¬¶ì–´ì„œ latest íƒœê·¸ ìƒì„±
          docker buildx imagetools create -t ${{ secrets.DOCKER_IMAGE_NAME }}:latest \
            ${{ secrets.DOCKER_IMAGE_NAME }}:amd64 \
            ${{ secrets.DOCKER_IMAGE_NAME }}:arm64

  # ==================================================================================
  # JOB 3: ì„œë²„ ë°°í¬
  # ==================================================================================
  docker-pull-and-run:
    name: Pull Latest Docker Image and Run on Home Server
    needs: merge-manifest
    runs-on: ubuntu-latest
    steps:
      - name: SSH ì ‘ì† ë° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_USERNAME }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            echo "[1] dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤."
            if which docker > /dev/null 2>&1; then
              echo "âœ… dockerê°€ ì •ìƒì ìœ¼ë¡œ ì¸ì‹ë©ë‹ˆë‹¤: $(which docker)"
            else
              echo "âŒ dockerë¥¼ PATHì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. PATHë¥¼ ë“±ë¡í•©ë‹ˆë‹¤."
              export PATH="$PATH:/usr/local/bin"
              if which docker > /dev/null 2>&1; then
                echo "âœ… PATH ë“±ë¡ í›„ docker ì¸ì‹ë¨: $(which docker)"
              else
                echo "âŒ ì—¬ì „íˆ dockerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ ë˜ëŠ” ì„¤ì¹˜ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”."
                exit 1
              fi
            fi

            echo "âœ… Docker ì´ë¯¸ì§€ Pull ì™„ë£Œ"

            echo "=============================="
            echo "ğŸ’ª env íŒŒì¼ pathë¡œ ì´ë™"
            echo "=============================="

            echo "ğŸ«¶ ì´ë™ ì „ ë””ë ‰í† ë¦¬: $(pwd)"
            cd ${{ secrets.SERVER_APP_DIRECTORY }}
            echo "âœ… í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"

            echo "ğŸ’ª Creating .env files"
            echo "${{ secrets.DOTENV_DEFAULT }}" | awk 'NF' > .env
            echo "âœ… .env files created"

            echo "=============================="
            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œì‘"
            echo "=============================="

            echo "ğŸ“ Compose íŒŒì¼ ê²½ë¡œ: ${{ secrets.SERVER_DOCKER_COMPOSE_PATH }}"
            if [ ! -f "${{ secrets.SERVER_DOCKER_COMPOSE_PATH }}" ]; then
              echo "âŒ Compose íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${{ secrets.SERVER_DOCKER_COMPOSE_PATH }}"
              exit 1
            fi

            echo "=============================="
            echo "ğŸ“¦ ìµœì‹  Docker ì´ë¯¸ì§€ Pull ì‹œì‘"
            echo "=============================="

            docker compose -f "${{ secrets.SERVER_DOCKER_COMPOSE_PATH }}" pull --ignore-pull-failures

            echo "=============================="
            echo "ğŸ” Docker Compose UP ì‹œì‘"
            echo "=============================="

            docker compose -f "${{ secrets.SERVER_DOCKER_COMPOSE_PATH }}" up -d --remove-orphans

            echo "=============================="
            echo "âœ… Docker Compose ì‹¤í–‰ ì™„ë£Œ"
            echo "=============================="

            docker logs ${{secrets.SERVER_DOCKER_CONATINER_NAME}} --timestamps --tail 100

            echo "=============================="
            echo "ğŸ‰ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ"
            echo "=============================="
